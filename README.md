rewrite affnity service using C. more light way
